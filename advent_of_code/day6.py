text1 = """....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#..."""


text=""".....#..#................#...#.....#.......................................................#.............................##.......
......................#..............................................................#..............#..........................#..
.........#........................#.....................................................#..............#...........#........##....
..........#......................#.....#...#............#..........................#.....#........................................
#....................................................................................................................#............
.#....#......................#.......................#...............................#...#.....#...................#........#.....
..#..#.......................##........#...............................................................#........#.........#.......
..............................................................#...#.........#..#..................................................
.............####..................................#................#..#.....................................#.....#..............
..........#................#................................................#........................#.....#......................
..............................................#.........#.....................#..................#.......................#........
.........................................##..#.................................#.....#............................................
............#..#...#...............................#.#.....#...............#...............................#..............#.#.#..#
.................#..........#..#....#.....................#......................................##............#..................
.......#....#.....................#......##...................#..............#.................#........#..#......#...............
...............................................#.............#....................................................................
..............#..............................................##..................#..........................#............#........
................#.......................#..#............................................................#..........#..#.........#.
.#.......................###............#.........#.................................................#.............................
........#......................................................................................#.....#.......#...#................
#.#.........................#..#.............................................#....#........................#......................
.......#.....#...............................#.....#......................#.................................#.....#...#...........
................................................................................................#............#....................
.......#......#...............#...#............................#................................#................................#
.#.....................................................................................................................#......#...
...........#..........................................#........#...................#..............................................
....#......................................................................................#.....##.#...................#.........
...#..........................................................................##.......................................#.....#....
#........#................#...............#.........#..#.#..............##..............#........#............#....#.....#........
......#......................................#...............#....#..#...........................#................................
#..............................................................................#............#...#..#....................#......#..
.......#.........................................#.........#.......#....................................#.........................
......#......#.............................................#.....................#...........#.............#..#...................
#.......................#........#............................................##..............................#...................
..........................................................................#........................................#....#......#..
..........#..#...............................................#............................#.#..............................#......
....#...........#..#...................................#................................................................#.........
..............#..........#...............#....#.....................................#.......................#.....................
.............#........#....#.........#...............#.........#..................................................................
.#......#...................#.......#...........................................................................#.............#...
.............##...........#.........................................#......................#.......................#..............
.....#................#.....#...................##.......#......#...........#.......#............................................#
.#..#.............................................................#..............................................#................
...#......#............................#..........................................................................................
...................................................................................#..............................................
#...................................#...................##..................#...............................................#.....
................#.....#...........................#...............................................................................
.................................#............#........................................................#.............#............
..................#......#........................................................#..^.....#......................................
..#.....#.................................................#........#.........................................................#..#.
................#..............................#....................................................#.............................
................#....#..........................................#............................#....................................
...............#.......................................#.....................................#..............................#.....
..................................................#............#..............#........##.#.....................................#.
.#..................................#......#..#............#.................#.............#......#..#.......................#....
..................#..............................#..........................#..........................##............#.......#....
.........#..................................................................#...................#..........................#......
................#....................................#............#............................................................#..
..##..........#.#..#........................#....#.................................#.............................................#
............................................#.........................................................#..#...................#...#
.......................................#......................................................................#...................
....#.......................#...#.........................................................................#................#......
...........#...........#............#.....#...#...................#........................................#.................##...
....#...........................................................................................#.................................
..............................................................................#.#.............................................#...
.........#..#..............................................#......................................................................
#...................#........#............#.......#.....................#................#.#.#............#..................#....
.......................#................#.....#...........#.....................#...........................#..........#.........#
........................................................................#.#.....................#.................................
...#.................................................#..........................#........#.......................#................
............................#...........#.......#.................................#.##...........#............................#...
...##.....................................#.........................#...........#...................................#.............
#.#..#................................#.........#..#.#..........#......................#............#......................#......
....#.............................................................#...............................................................
...............#.#......#........................................................................#.........................#......
................#.....#...#...............#.........................................#....#...........................#.......#....
...............#.........................................................................#........................................
..........................#..##...................................................................................................
.##....................#..#.....................#..............................................#........................#.........
............................................................................................#............#........................
#...................#...#......................#...............#............#....................................#................
...........................#........#......................................................................#......................
................................#...#...#.#.......#.................#.......#................##...................................
........................#.......................#.................................................................................
#...#...............#.........................................................................#.......................#...........
.........#...................#...............................................#...................##..............................#
.....#............................................................................................................................
.#.......#...............................................................#.......................#................#..........#....
....................................#..........#......#...........................................................#.#.#..#...#....
......................#..............................................##..................#........................................
....#......#...................#................#..............................................................................#..
...........#.................##.#...................................................#..#................#.........................
......#.....#......#...#........#.....................................#....#...........#................#..........#..............
#.......##.....#........#...........................................#...#..........#.............#........#.......#...............
......................#......#...................#.........................#........................#..................#...#......
.....#...........#...#.........................##.......#.....................................#...................................
....................................................................#.............................................................
........#...............#.........................................................................................................
.......................#.........................#..........................................#.#....#..#....#......................
........................##............................................................#.....#.........#....#......#..#............
........................#........#..................#................#.#.##............#..........................................
.......................................................#.........................#...............##...................##....#...#.
........#...#.............#...........#........#......................#...#.........#..#..................#.#............#........
#.#....................#..........................................#...................................................#........#..
...............................................#............#.....#.#...........#........#.#....................................#.
......#..........................................#............................................................#..........#...#...#
....................#......................................#....#..............................#....................#.............
......................#.#.....#......#....#..#....................................................................................
.....#..........................................#.........#...................................#................#.......#..........
........##....................................................................#...................................#.............#.
#.........................................#..#....#................#.#.....#....................#............................#....
#....#..#..........#..................#......................#....................................................................
...................#..#....#...................#...........................#.#..#............#......#................#.......#.#..
...............#......................................................#......#..#..............#.....................#............
............#.....................#.........#....#...............#.......#...#...............#.......................##.#.........
....#............#..................#....#.......................#..............................................#...#.............
..........................................#....#..........#..#....................#......#......................#...#.............
............#..........#...........#......#..#......................................................................#.............
...#.................#.............................................................#..............................................
.....#.#.........#....................................................#..................#...............#........................
..#......................##.....#.........#..............#..#............#..#............................................#........
...................#.....#.........#........#....................#..................................#................#............
....#.............................#.............................#.......................#.......................#.....#...........
...#......#....#...........#............................#.....#........#......#...................................................
........#..........#............................#..#..#.......................................#....#.##...........................
.......#......##........#.................#.............................................................#....#........#...........
.....................#............................................#.#......#.....##....#........#.................................
...........#.....................##.#....#..#.....................................................................................
....................#......#................................#.....................................................#.......#..#....
.....................................................#.........#.......................................#.....##..#................"""


def parse_input(text):
    return [list(l) for l in text.split("\n")]

def find_start(mapp):
    for i in range(len(mapp)):
        for j in range(len(mapp[i])):
            if mapp[i][j] == "^":
                return (i,j)


def get_total_visited(text):
    mapp = parse_input(text)
    maxr = len(mapp)
    maxc = len(mapp[0])

    next_dirs = {
        "up": "right",
        "right": "down",
        "down": "left",
        "left": "up",
    }
    dir_map = {
        "up": (-1,0),
        "right": (0,1),
        "down": (1,0),
        "left": (0,-1),
    }

    obstacles = set()
    obstacles_map = {}
    curr_dir = "up"
    curr_pos = find_start(mapp)
    print("start:", curr_pos)
    visited = set(curr_pos)

    steps_count = 1

    while 0 <= curr_pos[0] < maxr and 0 <= curr_pos[1] < maxc:
        
        next_pos = (curr_pos[0] + dir_map[curr_dir][0], curr_pos[1] + dir_map[curr_dir][1])

        if next_pos[0]>maxr-1 or next_pos[1]>maxc-1:
            break

        elif mapp[next_pos[0]][next_pos[1]] == "#":
            obstacles.add((next_pos[0],next_pos[1]))
            key = str(next_pos[0])+','+str(next_pos[1])

            if not obstacles_map.get(key):
                obstacles_map[key] = set()

            incoming_direction = (dir_map[curr_dir][0] * -1, dir_map[curr_dir][1] * -1)
            obstacles_map[key].add(incoming_direction)

            curr_dir = next_dirs[curr_dir]
            next_pos = (curr_pos[0] + dir_map[curr_dir][0], curr_pos[1] + dir_map[curr_dir][1])

        else:
            curr_pos = next_pos
            if not curr_pos in visited:
                visited.add(curr_pos)
                steps_count += 1

    return steps_count


def simulate_with_obstruction(mapp, obstruction_pos):
    maxr, maxc = len(mapp), len(mapp[0])
    next_dirs = {
        "up": "right",
        "right": "down",
        "down": "left",
        "left": "up",
    }
    dir_map = {
        "up": (-1, 0),
        "right": (0, 1),
        "down": (1, 0),
        "left": (0, -1),
    }

    curr_dir = "up"
    curr_pos = find_start(mapp)
    visited_with_directions = set()
    visited_with_directions.add((curr_pos, curr_dir))

    while 0 <= curr_pos[0] < maxr and 0 <= curr_pos[1] < maxc:
        next_pos = (curr_pos[0] + dir_map[curr_dir][0], curr_pos[1] + dir_map[curr_dir][1])

        if next_pos == obstruction_pos or (
            0 <= next_pos[0] < maxr and 0 <= next_pos[1] < maxc and mapp[next_pos[0]][next_pos[1]] == "#"
        ):
            curr_dir = next_dirs[curr_dir]
        else:
            curr_pos = next_pos

        if (curr_pos, curr_dir) in visited_with_directions:
            return True
        visited_with_directions.add((curr_pos, curr_dir))

        if not (0 <= curr_pos[0] < maxr and 0 <= curr_pos[1] < maxc):
            break

    return False

def get_looping_positions(text):
    mapp = parse_input(text)
    maxr, maxc = len(mapp), len(mapp[0])
    start_pos = find_start(mapp)
    looping_positions = set()

    for r in range(maxr):
        for c in range(maxc):
            if (r, c) == start_pos or mapp[r][c] == "#":
                continue
            if simulate_with_obstruction(mapp, (r, c)):
                looping_positions.add((r, c))

    return looping_positions




steps_count = get_total_visited(text)
print("total steps: ", steps_count)

looping_positions = get_looping_positions(text)
print("Number of possible positions for obstruction:", len(looping_positions))
